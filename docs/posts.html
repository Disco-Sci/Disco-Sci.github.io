<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />




<title>posts.knit</title>

<script src="site_libs/header-attrs-2.29/header-attrs.js"></script>
<script src="site_libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/united.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<style>h1 {font-size: 34px;}
       h1.title {font-size: 38px;}
       h2 {font-size: 30px;}
       h3 {font-size: 24px;}
       h4 {font-size: 18px;}
       h5 {font-size: 16px;}
       h6 {font-size: 12px;}
       code {color: inherit; background-color: rgba(0, 0, 0, 0.04);}
       pre:not([class]) { background-color: white }</style>
<script src="site_libs/jqueryui-1.13.2/jquery-ui.min.js"></script>
<link href="site_libs/tocify-1.9.1/jquery.tocify.css" rel="stylesheet" />
<script src="site_libs/tocify-1.9.1/jquery.tocify.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<link href="site_libs/pagedtable-1.1/css/pagedtable.css" rel="stylesheet" />
<script src="site_libs/pagedtable-1.1/js/pagedtable.js"></script>

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>










<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
details > summary > p:only-child {
  display: inline;
}
pre code {
  padding: 0;
}
</style>


<style type="text/css">
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #adb5bd;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script type="text/javascript">
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark the anchor link active (and if it's in a dropdown, also mark that active)
  var dropdown = menuAnchor.closest('li.dropdown');
  if (window.bootstrap) { // Bootstrap 4+
    menuAnchor.addClass('active');
    dropdown.find('> .dropdown-toggle').addClass('active');
  } else { // Bootstrap 3
    menuAnchor.parent().addClass('active');
    dropdown.addClass('active');
  }

  // Navbar adjustments
  var navHeight = $(".navbar").first().height() + 15;
  var style = document.createElement('style');
  var pt = "padding-top: " + navHeight + "px; ";
  var mt = "margin-top: -" + navHeight + "px; ";
  var css = "";
  // offset scroll position for anchor links (for fixed navbar)
  for (var i = 1; i <= 6; i++) {
    css += ".section h" + i + "{ " + pt + mt + "}\n";
  }
  style.innerHTML = "body {" + pt + "padding-bottom: 40px; }\n" + css;
  document.head.appendChild(style);
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before, .tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "\e259";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "\e258";
  font-family: 'Glyphicons Halflings';
  border: none;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->



<style type="text/css">

#TOC {
  margin: 25px 0px 20px 0px;
}
@media (max-width: 768px) {
#TOC {
  position: relative;
  width: 100%;
}
}

@media print {
.toc-content {
  /* see https://github.com/w3c/csswg-drafts/issues/4434 */
  float: right;
}
}

.toc-content {
  padding-left: 30px;
  padding-right: 40px;
}

div.main-container {
  max-width: 1200px;
}

div.tocify {
  width: 20%;
  max-width: 260px;
  max-height: 85%;
}

@media (min-width: 768px) and (max-width: 991px) {
  div.tocify {
    width: 25%;
  }
}

@media (max-width: 767px) {
  div.tocify {
    width: 100%;
    max-width: none;
  }
}

.tocify ul, .tocify li {
  line-height: 20px;
}

.tocify-subheader .tocify-item {
  font-size: 0.90em;
}

.tocify .list-group-item {
  border-radius: 0px;
}


</style>



</head>

<body>


<div class="container-fluid main-container">


<!-- setup 3col/9col grid for toc_float and main content  -->
<div class="row">
<div class="col-xs-12 col-sm-4 col-md-3">
<div id="TOC" class="tocify">
</div>
</div>

<div class="toc-content col-xs-12 col-sm-8 col-md-9">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-bs-toggle="collapse" data-target="#navbar" data-bs-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">Disco-Sci Blog</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="index.html">Home</a>
</li>
<li>
  <a href="posts.html">Posts</a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div id="header">




</div>


<br>
<div style="margin-bottom:60px;">

</div>
<div id="mar-06-2025---the-first-commit" class="section level2">
<h2>MAR 06 2025 - The first commit</h2>
<div style="margin-bottom:15px;">

</div>
<div id="what-is-it" class="section level3">
<h3>What is it?</h3>
<p>An R script.</p>
<div style="margin-bottom:15px;">

</div>
</div>
<div id="what-does-it-do" class="section level3">
<h3>What does it do?</h3>
<div style="margin-bottom:15px;">

</div>
<ol style="list-style-type: decimal">
<li>Performs an automated flow cytometry analysis workflow</li>
</ol>
<ul>
<li>Automatically compensates data</li>
<li>Automatically transforms data into logicle scale</li>
<li>Automatically gates and counts the major T cell groupings
<ul>
<li>CD3+/CD4/CD8</li>
</ul></li>
</ul>
<div style="margin-bottom:15px;">

</div>
<p><img src="posts_files/figure-html/unnamed-chunk-2-1.png" width="384" /><img src="posts_files/figure-html/unnamed-chunk-2-2.png" width="384" /></p>
<div style="margin-bottom:15px;">

</div>
<ol start="2" style="list-style-type: decimal">
<li>Outputs organized data</li>
</ol>
<ul>
<li>Outputs dataframes of counts into experimental groupings
<ul>
<li>Mapped in the dataframe is the hard coded data originating from each
FCS file</li>
</ul></li>
<li>Outputs % values of major T cell groupings</li>
<li>Outputs 5-number summary</li>
</ul>
<div style="margin-bottom:30px;">

</div>
<div id="tabled-or-df-outputs"
class="section level5 tabset tabset-fade tabset-pills">
<h5 class="tabset tabset-fade tabset-pills">Tabled (or DF) Outputs</h5>
<div id="counts" class="section level6">
<h6>Counts</h6>
<div data-pagedtable="false">
<script data-pagedtable-source type="application/json">
{"columns":[{"label":[""],"name":["_rn_"],"type":[""],"align":["left"]},{"label":["Sample"],"name":[1],"type":["chr"],"align":["left"]},{"label":["Experiment"],"name":[2],"type":["chr"],"align":["left"]},{"label":["Filename"],"name":[3],"type":["chr"],"align":["left"]},{"label":["Device"],"name":[4],"type":["chr"],"align":["left"]},{"label":["Device.Serial"],"name":[5],"type":["chr"],"align":["left"]},{"label":["Target(s)"],"name":[6],"type":["chr"],"align":["left"]},{"label":["Colors"],"name":[7],"type":["chr"],"align":["left"]},{"label":["CD8+CD4+"],"name":[8],"type":["dbl"],"align":["right"]},{"label":["CD8-CD4+"],"name":[9],"type":["dbl"],"align":["right"]},{"label":["CD8+CD4-"],"name":[10],"type":["dbl"],"align":["right"]},{"label":["CD8-CD4-"],"name":[11],"type":["dbl"],"align":["right"]}],"data":[{"1":"15001.476323","2":"Flu phenodavisPl1","3":"15001_B2_B02.476323.fcs","4":"LSRII","5":"H47100031","6":"CD4 CD3 CD28 CD8","7":"Pacific.Blue.A Am.Cyan.A APC.A APC.Cy7.A","8":"2094","9":"34534","10":"29789","11":"5736","_rn_":"1"},{"1":"15001.476325","2":"Flu phenodavisPl1","3":"15001_C2_C02.476325.fcs","4":"LSRII","5":"H47100031","6":"CD27 CD4 CD3 CD8","7":"PE.A Pacific.Blue.A Am.Cyan.A APC.Cy7.A","8":"2043","9":"33173","10":"28342","11":"5529","_rn_":"2"},{"1":"15001.476327","2":"Flu phenodavisPl1","3":"15001_D2_D02.476327.fcs","4":"LSRII","5":"H47100031","6":"CD27 CD45RA CD4 CD3 CD8","7":"PE.A PE.Cy5.A Pacific.Blue.A Am.Cyan.A APC.Cy7.A","8":"2085","9":"33973","10":"28710","11":"5708","_rn_":"3"},{"1":"15001.476330","2":"Flu phenodavisPl1","3":"15001_E2_E02.476330.fcs","4":"LSRII","5":"H47100031","6":"CD56 CD33 CD3 TCRgd CD19","7":"PE.A PE.Cy7.A Am.Cyan.A APC.A Alexa.700.A","8":"6","9":"210","10":"14","11":"73517","_rn_":"4"},{"1":"15002.476333","2":"Flu phenodavisPl1","3":"15002_A3_A03.476333.fcs","4":"LSRII","5":"H47100031","6":"CD4 CD3 CD8","7":"Pacific.Blue.A Am.Cyan.A APC.Cy7.A","8":"363","9":"41068","10":"30008","11":"5422","_rn_":"5"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
<div id="percentages" class="section level6">
<h6>Percentages</h6>
<div data-pagedtable="false">
<script data-pagedtable-source type="application/json">
{"columns":[{"label":[""],"name":["_rn_"],"type":[""],"align":["left"]},{"label":["Sample"],"name":[1],"type":["chr"],"align":["left"]},{"label":["Experiment"],"name":[2],"type":["chr"],"align":["left"]},{"label":["Filename"],"name":[3],"type":["chr"],"align":["left"]},{"label":["Device"],"name":[4],"type":["chr"],"align":["left"]},{"label":["Device.Serial"],"name":[5],"type":["chr"],"align":["left"]},{"label":["Target(s)"],"name":[6],"type":["chr"],"align":["left"]},{"label":["Colors"],"name":[7],"type":["chr"],"align":["left"]},{"label":["CD8+CD4+"],"name":[8],"type":["chr"],"align":["left"]},{"label":["CD8-CD4+"],"name":[9],"type":["chr"],"align":["left"]},{"label":["CD8+CD4-"],"name":[10],"type":["chr"],"align":["left"]},{"label":["CD8-CD4-"],"name":[11],"type":["chr"],"align":["left"]},{"label":["Total"],"name":[12],"type":["chr"],"align":["left"]}],"data":[{"1":"15001.476323","2":"Flu phenodavisPl1","3":"15001_B2_B02.476323.fcs","4":"LSRII","5":"H47100031","6":"CD4 CD3 CD28 CD8","7":"Pacific.Blue.A Am.Cyan.A APC.A APC.Cy7.A","8":"2.9","9":"47.9","10":"41.3","11":"7.9","12":"100","_rn_":"15001.476323"},{"1":"15001.476325","2":"Flu phenodavisPl1","3":"15001_C2_C02.476325.fcs","4":"LSRII","5":"H47100031","6":"CD27 CD4 CD3 CD8","7":"PE.A Pacific.Blue.A Am.Cyan.A APC.Cy7.A","8":"3","9":"48","10":"41","11":"8","12":"100","_rn_":"15001.476325"},{"1":"15001.476327","2":"Flu phenodavisPl1","3":"15001_D2_D02.476327.fcs","4":"LSRII","5":"H47100031","6":"CD27 CD45RA CD4 CD3 CD8","7":"PE.A PE.Cy5.A Pacific.Blue.A Am.Cyan.A APC.Cy7.A","8":"3","9":"48.2","10":"40.7","11":"8.1","12":"100","_rn_":"15001.476327"},{"1":"15001.476330","2":"Flu phenodavisPl1","3":"15001_E2_E02.476330.fcs","4":"LSRII","5":"H47100031","6":"CD56 CD33 CD3 TCRgd CD19","7":"PE.A PE.Cy7.A Am.Cyan.A APC.A Alexa.700.A","8":"0","9":"0.3","10":"0","11":"99.7","12":"100","_rn_":"15001.476330"},{"1":"15002.476333","2":"Flu phenodavisPl1","3":"15002_A3_A03.476333.fcs","4":"LSRII","5":"H47100031","6":"CD4 CD3 CD8","7":"Pacific.Blue.A Am.Cyan.A APC.Cy7.A","8":"0.5","9":"53.4","10":"39","11":"7.1","12":"100","_rn_":"15002.476333"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
<div id="summary" class="section level6">
<h6>5# Summary</h6>
<div data-pagedtable="false">
<script data-pagedtable-source type="application/json">
{"columns":[{"label":[""],"name":["_rn_"],"type":[""],"align":["left"]},{"label":["Min"],"name":[1],"type":["dbl"],"align":["right"]},{"label":["Lower Hinge"],"name":[2],"type":["dbl"],"align":["right"]},{"label":["Median"],"name":[3],"type":["dbl"],"align":["right"]},{"label":["Upper Hinge"],"name":[4],"type":["dbl"],"align":["right"]},{"label":["Max"],"name":[5],"type":["dbl"],"align":["right"]}],"data":[{"1":"0.0","2":"0.50","3":"0.6","4":"1.90","5":"3.0","_rn_":"CD8+CD4+"},{"1":"0.1","2":"47.95","3":"52.7","4":"53.25","5":"72.9","_rn_":"CD8-CD4+"},{"1":"0.0","2":"12.85","3":"39.4","4":"40.30","5":"41.3","_rn_":"CD8+CD4-"},{"1":"6.5","2":"7.05","3":"8.0","4":"14.00","5":"99.8","_rn_":"CD8-CD4-"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
<div style="margin-bottom:100000px;">

</div>
</div>
</div>
</div>
<div id="what-does-it-require" class="section level3">
<h3>What does it require?</h3>
<div style="margin-bottom:5px;">

</div>
<ol style="list-style-type: decimal">
<li>FCS files generated from peripheral blood samples</li>
</ol>
<ul>
<li>Experimental information is embedded</li>
<li>Compensation matrix is embedded</li>
</ul>
<div style="margin-bottom:30px;">

</div>
</div>
<div id="script-details" class="section level3">
<h3>Script details</h3>
<p>My first commit is an R script dependent to the Bioconductor package
flowCore. All else is written in base R.</p>
<p>The script is mostly composed of wrapper functions that calls to the
base R or to flowCore packages.</p>
<p>It also leverages specifications by the flow cytometry operator at
time of acquisition and file generation. The procedure uses the marker
and channel pairing plus the spillover (AKA compensation) matrix to map
the workflow. Without this information the script will fail.</p>
<p>The workflow performs at a per file basis. It reads in the FCS file
and then compensates the intensity values before transforming values to
the “logicle-scale”.</p>
<p>Next the data is gated using sequential k-means clustering; in order
of channels the sequence is</p>
<ol style="list-style-type: decimal">
<li>FSC channel</li>
<li>CD3 channel</li>
<li>CD4 and CD8 channel</li>
</ol>
<p>My attached packages:</p>
<pre><code>##  [1] &quot;.GlobalEnv&quot;            &quot;package:ggcyto&quot;        &quot;package:flowWorkspace&quot;
##  [4] &quot;package:ncdfFlow&quot;      &quot;package:BH&quot;            &quot;package:flowCore&quot;     
##  [7] &quot;package:ggplot2&quot;       &quot;package:stats&quot;         &quot;package:graphics&quot;     
## [10] &quot;package:grDevices&quot;     &quot;package:utils&quot;         &quot;package:datasets&quot;     
## [13] &quot;package:methods&quot;       &quot;Autoloads&quot;             &quot;package:base&quot;</code></pre>
<div style="margin-bottom:30px;">

</div>
</div>
<div id="data-background" class="section level3">
<h3>Data background</h3>
<p>The data I sourced comes from Immport.org and the study I used to
build my procedure has 453 files; 8 of which come from single-stain
compensation samples (likely beads from the look of the size
uniformity).</p>
<div style="margin-bottom:30px;">

</div>
</div>
<div id="performance" class="section level3">
<h3>Performance</h3>
<p>Each file takes about 1.2 seconds to process on my M1 Macbook. The
reading of the FCS file and transformation of data are the biggest
computational tasks.</p>
<div style="margin-bottom:30px;">

</div>
</div>
<div id="link" class="section level3">
<h3>Link</h3>
<p><a href="https://github.com/Disco-Sci/openEnv_FCM_WF"
class="uri">https://github.com/Disco-Sci/openEnv_FCM_WF</a></p>
<div style="margin-bottom:30px;">

</div>
</div>
<div id="bugs" class="section level3">
<h3>Bugs</h3>
<p>There is a bug in the flowCore transform() method as of today. There
seems to be a coding issue in the package. I believe the Bioconductor
forum shows a work-around from the authors; however, I did not implement
the solution at this time.</p>
<p>My solution simply uses a tryCatch method and return NA values when
an error occurs. Of the 453 files I tried, only 10 or so failed to be
rescaled. I think at the next update I should be able to correct this
behavior.</p>
</div>
<div id="thoughts" class="section level3">
<h3>Thoughts</h3>
<p>There is a lot of room for improvement all around, but this is a
start.</p>
<p>User features for the scientist that I think would be useful are:</p>
<ul>
<li>method to auto-generate a compensation matrix</li>
<li>method to auto-generate scaling</li>
<li>QC method for auto-gating procedure</li>
<li>better and more appropriate auto-gating methods</li>
<li>visualization of gates layered over data</li>
<li>writing out of data to file</li>
</ul>
<p>Engineering features that would I think would improve performance
would be:</p>
<ul>
<li>QC logs</li>
<li>Packaging functions</li>
<li>Unit testing for package</li>
<li>Better control flows and more assignments</li>
<li>Refactoring to a more readable format</li>
</ul>
<p>Notes:</p>
<p>If something like this were to go into a production setting and into
regulated industry then requirements and documentation would be
needed.</p>
</div>
</div>



</div>
</div>

</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.odd').parent('tbody').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open');
  });
});
</script>

<!-- code folding -->

<script>
$(document).ready(function ()  {

    // temporarily add toc-ignore selector to headers for the consistency with Pandoc
    $('.unlisted.unnumbered').addClass('toc-ignore')

    // move toc-ignore selectors from section div to header
    $('div.section.toc-ignore')
        .removeClass('toc-ignore')
        .children('h1,h2,h3,h4,h5').addClass('toc-ignore');

    // establish options
    var options = {
      selectors: "h1,h2,h3",
      theme: "bootstrap3",
      context: '.toc-content',
      hashGenerator: function (text) {
        return text.replace(/[.\\/?&!#<>]/g, '').replace(/\s/g, '_');
      },
      ignoreSelector: ".toc-ignore",
      scrollTo: 0
    };
    options.showAndHide = true;
    options.smoothScroll = true;

    // tocify
    var toc = $("#TOC").tocify(options).data("toc-tocify");
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
