---
title: "Welcome to the Disco-Sci blog!"
output: 
  html_document:
    df_print: paged
    theme: united
    highlight: tango
    fig_width: 4
    fig_height: 4
    toc: true
    toc_depth: 3
    toc_float: 
      collapsed: true
      smooth_scroll: true
---

```{r global options, include=F}
knitr::opts_chunk$set(echo = F)
knitr::opts_chunk$set(cache = F)

library(ggcyto)
```

```{r, include = F}
source("~/Documents/Proj/DS/FCM/openEnv_FCM_WF/07MAR2025/src.R")
```


<div style="margin-bottom:30px;">
</div>

## MAR 06 2025 - The first commit

<div style="margin-bottom:30px;">
</div>

### What does it do?

<div style="margin-bottom:5px;"> </div>

1. Performs an automated flow cytometry analysis workflow

  - Automatically compensates data 
  - Automatically transforms data into logicle scale
  - Automatically gates and counts the major T cell groupings
    - CD3+/CD4/CD8

<div style="margin-bottom:15px;">
</div>

```{r, warning=F, message=F}
files <- flpaths_FCS_list("~/Documents/Proj/DS/FCM/Flow_studies/Test study/")[10]

fF <- loadFF(files)

colors <- markernames(fF)

lst <- list(x = c(0, 300000), y = c(0, 40000))

fF_staged <- get_hypsin_tfx_2(fF, colors)

lst <- list(x = c(-1, 5), y = c(-0.5, 3.5))

kmf <- kmeansFilter("FSC.A" = c("debris","lymph","macrophages"), filterId = "kfilter" )

kmf_results <- filter(fF_staged, kmf)

fF_staged <- split(fF_staged, kmf_results)$lymph

kmf <- kmeansFilter("Am.Cyan.A" = c("CD3neg","CD3pos"), filterId = "CD3" )
cd3_filter <- filter(fF_staged, kmf)
fF_staged <- split(fF_staged, cd3_filter)$CD3pos

p <- ggcyto(fF_staged, aes(x = "APC.Cy7.A", y = "Pacific.Blue.A")) + geom_hex(bins = 128) + ggcyto_par_set(limits = lst)

p + ggtitle("Transformed, but not compensated") + theme(plot.title = element_text(size = 10))

fF_staged <- flowCore::compensate(fF, fF@description[["SPILL"]])

fF_staged <- get_hypsin_tfx_2(fF_staged, colors)

kmf <- kmeansFilter("FSC.A" = c("debris","lymph","macrophages"), filterId = "kfilter" )

kmf_results <- filter(fF_staged, kmf)

fF_staged <- split(fF_staged, kmf_results)$lymph

kmf <- kmeansFilter("Am.Cyan.A" = c("CD3neg","CD3pos"), filterId = "CD3" )
cd3_filter <- filter(fF_staged, kmf)
fF_staged <- split(fF_staged, cd3_filter)$CD3pos

p <- ggcyto(fF_staged, aes(x = "APC.Cy7.A", y = "Pacific.Blue.A")) + geom_hex(bins = 128) + ggcyto_par_set(limits = lst)
  
p + ggtitle("Compensated + Transformed") + theme(plot.title = element_text(size = 10))

```

<div style="margin-bottom:15px;">
</div>

2. Outputs organized data

  - Outputs dataframes of counts into experimental groupings
    - Mapped in the dataframe is the hard coded data originating from each FCS file
  - Outputs % values of major T cell groupings
  - Outputs 5-number summary 

<div style="margin-bottom:30px;">
</div>

##### Tabled (or DF) Outputs {.tabset .tabset-fade .tabset-pills}

###### Counts
```{r}
grouped_exp_raw_lst[["Flu phenodavisPl1"]][1:5,]
```

###### Percentages

```{r}
grouped_exp_perc_lst[["Flu phenodavisPl1"]][1:5,]
```

###### 5# Summary

```{r}
perc_five_num_lst$`Flu phenodavisPl1` |> as.data.frame()
```

<div style="margin-bottom:30px;">
</div>

### What does it require?

<div style="margin-bottom:5px;">
</div>

1. FCS files generated from peripheral blood samples
  - Experimental information is embedded
  - Compensation matrix is embedded 

<div style="margin-bottom:30px;">
</div>

### Script details

My first commit is an R script dependent to the Bioconductor package flowCore. All else is written in base R.

The script is mostly composed of wrapper functions that calls to the base R or to flowCore packages.

It also leverages specifications by the flow cytometry operator at time of acquisition and file generation. The procedure uses the marker and channel pairing plus the spillover (AKA compensation) matrix to map the workflow. Without this information the script will fail. 

The workflow performs at a per file basis. It reads in the FCS file and then compensates the intensity values before transforming values to the "logicle-scale".

Next the data is gated using sequential k-means clustering; in order of channels the sequence is 

1. FSC channel
2. CD3 channel
3. CD4 and CD8 channel

My attached packages:
```{r}
search()
```

<div style="margin-bottom:30px;">
</div>

### Data background

The data I sourced comes from Immport.org and the study I used to build my procedure has 453 files; 8 of which come from single-stain compensation samples (likely beads from the look of the size uniformity).

<div style="margin-bottom:30px;">
</div>

### Performance

Each file takes about 1.2 seconds to process on my M1 Macbook. The reading of the FCS file and transformation of data are the biggest computational tasks. 

<div style="margin-bottom:30px;">
</div>

### Link

<https://github.com/Disco-Sci/openEnv_FCM_WF>

<div style="margin-bottom:30px;">
</div>

### Bugs

There is a bug in the flowCore transform() method as of today. There seems to be a coding issue in the package. I believe the Bioconductor forum shows a work-around from the authors; however, I did not implement the solution at this time. 

My solution simply uses a tryCatch method and return NA values when an error occurs. Of the 453 files I tried, only 10 or so failed to be rescaled. I think at the next update I should be able to correct this behavior. 

### Thoughts

There is a lot of room for improvement all around, but this is a start. 

User features for the scientist that I think would be useful are:

- method to auto-generate a compensation matrix
- method to auto-generate scaling 
- QC method for auto-gating procedure 
- better and more appropriate auto-gating methods 
- visualization of gates layered over data 
- writing out of data to file

Engineering features that would I think would improve performance would be:

- QC logs
- Packaging functions 
- Unit testing for package
- Better control flows and more assignments
- Refactoring to a more readable format

Notes: 

If something like this were to go into a production setting and into regulated industry then  requirements and documentation would be needed. 

 